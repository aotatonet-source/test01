<!DOCTYPE html>
<html>

<head>
	<base target="_top" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta property="og:title" content="霊園利用者登録 - 林泉寺" />
	<meta property="og:description" content="林泉寺DXシステム: 霊園利用者のLINE連携登録を行います。" />
	<!-- <meta property="og:image" content="https://rinsenji-dx-client.netlify.app/image/oqp.png" /> -->
	<meta property="og:image" content="https://aotatonet-source.github.io/test01/image/ogp.png" />
	<!-- Note: Assuming hosted path or needing replacement -->
	<title>霊園利用者登録</title>
	<style>
		body {
			font-family: 'Helvetica Neue', Arial, sans-serif;
			background: #f4f7f6;
			padding: 20px;
			color: #333;
		}

		.card {
			background: #fff;
			padding: 30px;
			border-radius: 16px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
			max-width: 500px;
			margin: 0 auto;
		}

		h1 {
			font-size: 1.5em;
			text-align: center;
			color: #2c3e50;
			margin-bottom: 20px;
		}

		.form-group {
			margin-bottom: 15px;
		}

		label {
			display: block;
			margin-bottom: 5px;
			font-weight: bold;
			color: #555;
			font-size: 0.9em;
		}

		input {
			width: 100%;
			padding: 12px;
			border: 1px solid #ddd;
			border-radius: 8px;
			box-sizing: border-box;
			font-size: 1em;
		}

		input:read-only {
			background-color: #f9f9f9;
			color: #777;
		}

		.section-title {
			font-size: 0.8em;
			color: #aaa;
			text-transform: uppercase;
			margin: 20px 0 10px;
			border-bottom: 1px solid #eee;
		}

		.btn {
			width: 100%;
			padding: 14px;
			background: #007bff;
			color: #fff;
			border: none;
			border-radius: 8px;
			font-size: 1em;
			font-weight: bold;
			cursor: pointer;
			margin-top: 10px;
		}

		.btn-secondary {
			background: #6c757d;
			margin-top: 5px;
			padding: 10px;
			font-size: 0.9em;
		}

		.btn-scan {
			background: #28a745;
			margin-bottom: 15px;
		}

		.btn-danger {
			background: #dc3545;
			margin-top: 20px;
			font-size: 0.9em;
		}

		.info-box {
			background: #e9ecef;
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 15px;
			display: none;
			border-left: 4px solid #007bff;
		}

		.info-item {
			font-size: 0.9em;
			margin-bottom: 5px;
		}

		.info-label {
			font-weight: bold;
			color: #495057;
			width: 80px;
			display: inline-block;
		}

		.error {
			color: #e74c3c;
			font-size: 0.85em;
			margin-top: 10px;
			display: none;
			padding: 10px;
			background: #fdeaea;
			border-radius: 6px;
			border: 1px solid #f5c6cb;
		}

		#loading {
			display: none;
			text-align: center;
			margin-top: 15px;
			color: #007bff;
		}

		#debug-container {
			display: none;
			margin-top: 20px;
			padding: 10px;
			background: #222;
			color: #0f0;
			border-radius: 5px;
			font-family: monospace;
			font-size: 0.7em;
		}
	</style>
</head>

<body>
	<div class="card">
		<h1>霊園利用者登録</h1>

		<div id="registration-content">
			<button class="btn btn-scan" onclick="handleScan()">QRコードを読み取る</button>

			<form id="reg-form" onsubmit="handleSubmit(event)">
				<div class="form-group">
					<label>システムID (12桁)</label>
					<div style="display:flex; gap:5px;">
						<input type="text" id="systemId" placeholder="IDを入力">
					</div>
				</div>

				<div style="text-align: center; margin: 10px 0; color: #888; font-size: 0.8em; position: relative;">
					<span style="background: #fff; padding: 0 10px; z-index: 1; position: relative;">または</span>
					<div
						style="position: absolute; top: 50%; left: 0; right: 0; border-top: 1px solid #eee; z-index: 0;">
					</div>
				</div>

				<div style="display:flex; gap:10px;">
					<div class="form-group" style="flex:1;">
						<label>ｶﾅ(半角)</label>
						<input type="text" id="inquiryKana" placeholder="ｻﾄｳﾀﾛｳ">
					</div>
					<div class="form-group" style="flex:1;">
						<label>電話番号</label>
						<input type="tel" id="inquiryTel" placeholder="ハイフン無し">
					</div>
				</div>

				<div style="margin-bottom: 20px;">
					<button type="button" class="btn btn-secondary" onclick="handleInquiry()">照会する</button>
				</div>

				<!-- 照会結果表示エリア -->
				<div id="danka-info" class="info-box">
					<div class="info-item"><span class="info-label">顧客CD:</span> <span id="res-cd"></span></div>
					<div class="info-item"><span class="info-label">ｶﾅ:</span> <span id="res-kana"></span></div>
					<div class="info-item"><span class="info-label">得意先名:</span> <span id="res-name"></span></div>
				</div>

				<div class="section-title">LINEに登録する情報</div>
				<div style="display:flex; gap:10px;">
					<div class="form-group" style="flex:1;"><label>姓</label><input type="text" id="lastName" required>
					</div>
					<div class="form-group" style="flex:1;"><label>名</label><input type="text" id="firstName" required>
					</div>
				</div>
				<div style="display:flex; gap:10px;">
					<div class="form-group" style="flex:1;"><label>姓（カナ）</label><input type="text" id="lastNameKana"
							required></div>
					<div class="form-group" style="flex:1;"><label>名（カナ）</label><input type="text" id="firstNameKana"
							required></div>
				</div>

				<button type="submit" id="submit-btn" class="btn" style="display:none;">この内容で登録する</button>
			</form>

			<div id="unlink-container" style="text-align:center; display:none;">
				<button type="button" class="btn btn-danger" onclick="handleUnlink()">登録を解除する</button>
			</div>
		</div>

		<div id="loading">通信中...</div>
		<div id="global-error" class="error"></div>

		<div id="debug-container">
			<div
				style="font-weight:bold; color:orange; margin-bottom:5px; display:flex; justify-content:space-between;">
				<span>■診断レポート</span>
				<span onclick="document.getElementById('debug-container').style.display='none'"
					style="cursor:pointer; color:#888;">[閉じる]</span>
			</div>
			<div id="debug-log" style="white-space:pre-wrap; max-height:150px; overflow-y:auto;"></div>
		</div>
	</div>

	<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
	<script>
		const LIFF_ID = "2008839253-KLrT6Xkx";
		const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwp6tyjKZi90NTp6wnWnvuZFFvbs_YWN5kK4ZuBDhxt9ddH6qPfrxjP_b6IaJzGXENJ/exec";

		let lineUserId = '';
		let idToken = '';

		async function init() {
			try {
				await liff.init({ liffId: LIFF_ID });
				if (!liff.isLoggedIn()) { liff.login(); return; }

				const ctx = liff.getContext();
				lineUserId = ctx ? ctx.userId : '';
				idToken = liff.getIDToken();

				if (!lineUserId) {
					const p = await liff.getProfile();
					lineUserId = p.userId;
				}

				const urlParams = new URLSearchParams(window.location.search);
				if (urlParams.get('debug') === '1') document.getElementById('debug-container').style.display = 'block';

				// Show Unlink button if we think they might be registered (can't know for sure without checking GAS, but UI availability is fine)
				// Or check logic? For now always show or maybe only after inquiry? 
				// "RegistrationForm.htmlに紐づけだけではなく、解除する機能を付ける"
				// Let's show it always at the bottom for convenience.
				document.getElementById('unlink-container').style.display = 'block';

			} catch (e) {
				showError('初期化失敗: ' + e.message);
			}
		}

		function showError(m) {
			const el = document.getElementById('global-error');
			el.innerText = m; el.style.display = 'block';
			document.getElementById('loading').style.display = 'none';
		}

		// QRスキャン機能
		async function handleScan() {
			if (!liff.isInClient()) {
				alert('QRスキャンはLINEアプリ内で実行してください。');
				return;
			}
			try {
				const result = await liff.scanCodeV2();
				if (result.value) {
					document.getElementById('systemId').value = result.value;
					handleInquiry(); // 自動照会
				}
			} catch (err) {
				alert('スキャンエラー: ' + err.message);
			}
		}

		// ID照会機能
		async function handleInquiry() {
			const sysId = document.getElementById('systemId').value;
			const kana = document.getElementById('inquiryKana').value;
			const tel = document.getElementById('inquiryTel').value;

			if (!sysId && (!kana || !tel)) {
				alert('システムID、または[ｶﾅと電話番号]を入力してください。');
				return;
			}
			if (sysId && sysId.length < 12) {
				alert('システムIDは12桁で入力してください。');
				return;
			}

			document.getElementById('loading').style.display = 'block';
			document.getElementById('global-error').style.display = 'none';
			document.getElementById('danka-info').style.display = 'none';
			document.getElementById('submit-btn').style.display = 'none';

			callGasApi({
				action: 'inquiry',
				payload: {
					systemId: sysId,
					kana: kana,
					tel: tel
				},
				idToken: idToken
			}, (res) => {
				document.getElementById('loading').style.display = 'none';
				if (res.success) {
					document.getElementById('res-cd').innerText = res.customerCd || '-';
					document.getElementById('res-kana').innerText = res.kana || '-';
					document.getElementById('res-name').innerText = res.name || '-';
					document.getElementById('danka-info').style.display = 'block';
					document.getElementById('submit-btn').style.display = 'block';
					// システムIDが空で照会した場合は、取得したIDをセットする
					if (!sysId && res.systemId) {
						document.getElementById('systemId').value = res.systemId;
					}
				} else {
					alert('照会エラー: ' + res.message);
				}
			});
		}

		async function handleSubmit(e) {
			e.preventDefault();
			if (!lineUserId) { alert('UserID取得不可。再起動してください。'); return; }

			if (!confirm('この内容で登録してよろしいですか？')) return;

			document.getElementById('loading').style.display = 'block';

			const payload = {
				lastName: document.getElementById('lastName').value,
				firstName: document.getElementById('firstName').value,
				lastNameKana: document.getElementById('lastNameKana').value,
				firstNameKana: document.getElementById('firstNameKana').value,
				lineUserId: lineUserId,
				systemId: document.getElementById('systemId').value,
				mode: 'link'
			};

			callGasApi({
				action: 'register',
				payload: payload,
				idToken: idToken
			}, (res) => {
				document.getElementById('loading').style.display = 'none';
				if (res.success) {
					alert('登録が完了しました。');
					liff.closeWindow();
				} else {
					showError('登録エラー: ' + res.message);
				}
			});
		}

		async function handleUnlink() {
			const sysId = document.getElementById('systemId').value;
			if (!sysId) {
				alert('解除するシステムIDを入力してください。');
				return;
			}

			if (!confirm(`システムID: ${sysId}\n本当にこのLINEアカウントの連携を解除しますか？`)) return;

			if (!lineUserId) { alert('UserID取得不可。'); return; }
			document.getElementById('loading').style.display = 'block';

			callGasApi({
				action: 'unlink',
				payload: { 
					lineUserId: lineUserId,
					systemId: sysId
				},
				idToken: idToken
			}, (res) => {
				document.getElementById('loading').style.display = 'none';
				if (res.success) {
					alert('連携を解除しました。');
					liff.closeWindow();
				} else {
					showError('解除エラー: ' + res.message);
				}
			});
		}

		// fetch API 通信 (POST)
		async function callGasApi(data, callbackSuccess) {
			try {
				const response = await fetch(GAS_API_URL, {
					method: 'POST',
					headers: {
						'Content-Type': 'text/plain' // Use text/plain to avoid preflight (CORS safety)
					},
					body: JSON.stringify(data)
				});

				const res = await response.json();
				callbackSuccess(res);
			} catch (err) {
				console.error(err);
				// "Failed to fetch" usually happens due to CORS or redirect issues with GAS.
				// However, the main cause is often GAS not returning a valid JSON due to errors.
				showError('通信エラー: ' + err.message);
			}
		}

		init();
	</script>
</body>

</html>
